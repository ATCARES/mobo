<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - lib\model\buildRegistry.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>lib\model\buildRegistry.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">60.30</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">292</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">43.86</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.92</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">//////////////////////////////////////////
// Requirements                         //
//////////////////////////////////////////

var fs                  = require(&#039;fs-extra&#039;);
var _                   = require(&#039;lodash&#039;);
var RSVP                = require(&#039;rsvp&#039;);

var logger              = require(&#039;../logger.js&#039;);
var log                 = logger.log;

var getDirectoryContent = require(&#039;../getDirectoryContent.js&#039;);


/**
 * Stores the JSON model into an internal registry object.
 * Additionally a &quot;deep&quot; registry is built that has all inheritances resolved
 *
 * TODO: This code should be rewritten
 * TODO: This supports no very deep inheritances, to avoid circular references
 *
 * @param settings
 * @returns {{}}
 */
exports.exec = function(settings, callback) {

    //////////////////////////////////////////
    // Variables                            //
    //////////////////////////////////////////

    var registry = {};


    //////////////////////////////////////////
    // READ MODEL TO REGISTRY               //
    //////////////////////////////////////////

    // Directories to fetch
    var directories = [&#039;field&#039;, &#039;model&#039;, &#039;form&#039;, &#039;smw_template&#039;, &#039;smw_query&#039;, &#039;smw_page&#039;];

    // Fill Registry
    var promises = directories.map(function(name){

        var promise = getDirectoryContent.read(settings.importModelDir + &#039;/&#039; + name + &#039;/&#039;);
        promise.then(function(content) {
            registry[name] = content;
        }, function(err) {
            log(&#039;&gt; [ERROR] Could not read project directory /&#039; + name);
            log(err);
        });
        return promise;
    });

    // After all directories are read
    RSVP.all(promises).then(function() {

        /** Fallback for @deprecated project structure! */
        if (!registry.smw_page) {
            registry.smw_page = getDirectoryContent.read(settings.importModelDir + &#039;/smw_site/&#039;);
            log(&#039;&gt; [WARNING] Wiki pages are now stored into /smw_site/ folder instead of /smw_page/ !&#039;);
            log(&#039;&gt; [WARNING] Please rename your directory accordingly!&#039;);
        }

        //////////////////////////////////////////
        // EXPAND REGISTRY THROUGH INHERITANCE  //
        //////////////////////////////////////////

        registry.expandedModel = exports.expandModels(registry);
        registry.expandedForm = exports.expandForms(registry);

        // Write Registry to file
        fs.outputFileSync(settings.processedModelDir + &#039;/_registry.json&#039;, JSON.stringify(registry, null, 4));

        callback(false, registry);


    }).catch(function(error){
        callback(error, false);
    });

};

/**
 * Expands all models through their external refs.
 * This will introduce inheritance
 *
 * @param registry
 * @returns {{}}
 */
exports.expandModels = function(registry) {

    var model;

    //////////////////////////////////////////
    // Build Full Referenced Registry       //
    //////////////////////////////////////////

    // Make deep clone of models
    var expandedModelRegistry = _.cloneDeep(registry.model);

    // Resolve all Models in the Deep Registry
    for (var modelName in expandedModelRegistry) {
        model = expandedModelRegistry[modelName];
        exports.inherit(model, registry);
        exports.orderObjectProperties(model);
    }

    // CleanUp / Post-Processing
    for (modelName in expandedModelRegistry) {
        model = expandedModelRegistry[modelName];
        model[&quot;$schema&quot;] = &quot;http://json-schema.org/draft-04/schema#&quot;;
    }

    return expandedModelRegistry;

};

/**
 * Expands all Forms through their $extend atributes
 *
 * @param registry
 * @returns {{}}
 */
exports.expandForms = function(registry) {

    var deepForm = {};

    for (var formName in registry.form) {

        var form = registry.form[formName];

        deepForm[formName] = _.cloneDeep(form);
        deepForm[formName].id = formName;

        for (var propertyName in form.properties) {

            var property = form.properties[propertyName];
            var refArray = [];
            var name;

            if (property.$extend) {

                refArray = property.$extend.split(&#039;/&#039;);

                if (refArray[1] === &#039;smw_template&#039;) {
                    name = refArray[refArray.length - 1].replace(&#039;.wikitext&#039;, &#039;&#039;);

                    deepForm[formName].properties[name] = property;

                    deepForm[formName].properties[propertyName].id = name;
                    deepForm[formName].properties[propertyName].type = &quot;string&quot;;
                    deepForm[formName].properties[propertyName].format = property.$extend;
                    deepForm[formName].properties[propertyName].template = registry.smw_template[refArray[2]];

                } else {
                    name = refArray[refArray.length - 1].replace(&#039;.json&#039;, &#039;&#039;);
                    deepForm[formName].properties[propertyName] = registry.expandedModel[name];
                }

            } else if (property.items &amp;&amp; property.items.$extend) {
                refArray = property.items.$extend.split(&#039;/&#039;);
                name = refArray[2].replace(&#039;.json&#039;, &#039;&#039;);
                deepForm[formName].properties[propertyName].items = registry.expandedModel[name];

            } else if (property.wikitext) {
                // Ignore, wikitext is used just for form display
            } else {
                log(property, false);
                log(&#039;&gt;&gt;&gt; [WARNING] Form &quot;&#039; + formName + &#039;&quot; is missing its $extend attributes!&#039;);
            }
        }

    }

    return deepForm;

};

/**
 * Recursive Function that looks for $extends and resolves them
 * Warning: Does not support circular Structures! Will run forever.
 *
 * @param model
 * @param registry
 */
exports.inherit = function(model, registry) {

    // Model inheritance should be implemented via allOf[] !
    // Field inheritance may be implemented through a simple $extend
    if (model.$extend || model.allOf || model.anyOf) {

        var refArray = [];

        // TODO: This might be wrong, since allOf might not be just an array of $extends!
        if (model.allOf) {
            refArray = model.allOf;
        } else if (model.anyOf) {
            refArray = model.anyOf;
        }

        if (model.$extend) {
            refArray.push(model.$extend);
        }

        if (model.$extend) {
            refArray.push(model.$extend);
        }

        for (var i = 0; i &lt; refArray.length; i++) {
            exports.replaceRef(model, refArray[i].$extend, registry);
        }
    }

    // Merge Fields into Models
    if (model.properties) {
        for (var attrName in model.properties) {
            exports.inherit(model.properties[attrName], registry);
        }
    }

    // Special Case: Handle Array Items
    if (model.items) {
        exports.inherit(model.items, registry);
    }

};

/**
 * Merges fetched content of $extend tag with own content
 * Helper Function
 *
 * @param obj
 * @param $extend
 * @param registry
 */
exports.replaceRef = function(obj, $extend, registry) {

    if (obj.$extend || $extend) {

        var refArray = [];

        if ($extend) {
            refArray = $extend.split(&#039;/&#039;);
        } else {
            refArray = obj.$extend.split(&#039;/&#039;);
        }

        var type = refArray[1];
        var name = refArray[refArray.length - 1].replace(&#039;.json&#039;, &#039;&#039;);

        var reference = registry[type][name];

        // Inheritance
        var mergeObject = _.cloneDeep(reference);
        _.merge(mergeObject, obj);
        _.merge(obj, mergeObject);

        obj.$reference = obj.$extend || $extend;

        // Cleanup
        if (obj.$extend) { delete obj.$extend; }
        if (obj.allOf) { delete obj.allOf; }
        if (obj.$schema) { delete obj.$schema; }

    }
};


/**
 * Orders Model Properties by propertyOrder Array
 *
 * Properties which aren&#039;t given in the array are positioned at the bottom
 *
 * @param model
 */
exports.orderObjectProperties = function(model) {

    if (model.properties &amp;&amp; model.propertyOrder) {

        var newOrder = {};

        for (var i = 0; i &lt; model.propertyOrder.length; i++) {
            var propertyName = model.propertyOrder[i];
            if (model.properties[propertyName]) {
                newOrder[propertyName] = model.properties[propertyName];
            } else {
                log(&#039;&gt; [WARNING] Model &#039; + model.id + &#039; has non existent property &quot;&#039; + propertyName + &#039;&quot; in the propertyOrder array!&#039;);
            }
        }

        _.merge(newOrder, model.properties);

        model.properties = newOrder;
    }

};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
